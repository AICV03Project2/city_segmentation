<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seoul â‡„ Suwon Traffic CCTV Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    :root {
      --sky-50: #f2fbff;
      --sky-100: #e6f7ff;
      --sky-200: #cfefff;
      --sky-300: #010202;
      --sky-500: #35b7ff;
      --sky-700: #167db6;
      --ink: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --border: #dbeafe;
    }

    body {
      background: radial-gradient(1200px 800px at 20% 0%, var(--sky-100), transparent 60%),
        radial-gradient(1200px 800px at 80% 0%, #e9f7ff, transparent 55%),
        linear-gradient(180deg, var(--sky-50), #ffffff 40%);
      color: var(--ink);
      min-height: 100vh;
    }

    .app-shell {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px 14px 18px;
    }

    .topbar {
      background: rgba(255, 255, 255, .75);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, .06);
      padding: 14px 16px;
    }

    .brand-btn {
      border: 0;
      background: transparent;
      font-weight: 800;
      letter-spacing: -0.3px;
      font-size: 20px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--ink);
      cursor: pointer;
    }

    .brand-badge {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--sky-300), var(--sky-500));
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 900;
      box-shadow: 0 10px 18px rgba(53, 183, 255, .25);
    }

    .subtitle {
      color: var(--muted);
      font-size: 13px;
    }

    .pill {
      border: 1px solid var(--border);
      border-radius: 999px;
      background: white;
      padding: 6px 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .segmented {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px;
      display: inline-flex;
      gap: 6px;
    }

    .segmented .seg-btn {
      border: 0;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      font-size: 13px;
      color: var(--muted);
      background: transparent;
      transition: .15s ease;
      white-space: nowrap;
    }

    .segmented .seg-btn.active {
      background: linear-gradient(135deg, var(--sky-300), var(--sky-500));
      color: white;
      box-shadow: 0 10px 18px rgba(53, 183, 255, .22);
    }

    .panel {
      background: rgba(255, 255, 255, .8);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, .06);
    }

    .panel-header {
      padding: 12px 14px 0 14px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 800;
      letter-spacing: -0.2px;
      margin: 0;
    }

    .panel-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .video-wrap {
      padding: 12px 14px 14px;
    }

    .frame {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 14px;
      overflow: hidden;
      background: linear-gradient(180deg, #f0f9ff, #e0f2fe);
      border: 1px solid rgba(148, 208, 255, .6);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
    }

    .frame.map-frame img {
      object-fit: contain;
      background: #fff;
    }


    .frame img,
    .frame video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .frame .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 10px 10px;
      pointer-events: none;
      background: linear-gradient(180deg, transparent 65%, rgba(2, 6, 23, .45));
      color: white;
      font-size: 12px;
      font-weight: 700;
    }

    .overlay .tag {
      background: rgba(53, 183, 255, .22);
      border: 1px solid rgba(255, 255, 255, .3);
      padding: 4px 8px;
      border-radius: 999px;
      backdrop-filter: blur(8px);
    }

    .map-frame {
      aspect-ratio: 1 / 1;
    }

    .small-frame {
      aspect-ratio: 16/10;
    }

    .analysis-zone {
      padding: 14px;
    }

    .metric {
      background: white;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      height: 100%;
    }

    .metric .k {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
    }

    .metric .v {
      font-size: 22px;
      font-weight: 900;
      letter-spacing: -0.5px;
      line-height: 1.1;
    }

    .metric .hint {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .btn-sky {
      background: linear-gradient(135deg, var(--sky-300), var(--sky-500));
      border: 0;
      color: white;
      font-weight: 800;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 12px 20px rgba(53, 183, 255, .22);
    }

    .btn-sky:hover {
      filter: brightness(.98);
    }

    .footer-note {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .h-stretch {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .h-stretch .video-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* ===== Hover ì œì™¸(ì§€ë„/ì°¨íŠ¸) ===== */
    .no-hover {
      cursor: default;
    }

    .no-hover:hover {
      transform: none !important;
      box-shadow: none !important;
    }

    /* ===== CCTV í´ë¦­ í™•ëŒ€(ëª¨ë‹¬) ===== */
    .cctv {
      cursor: zoom-in;
    }

    #cctvModal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.62);
      z-index: 9999;
      padding: 24px;
    }

    #cctvModal.open {
      display: flex;
    }

    #cctvModal .modal-card {
      width: min(92vw, 1200px);
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
    }

    #cctvModal .modal-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      color: rgba(255, 255, 255, 0.9);
      font-weight: 800;
      letter-spacing: -0.2px;
    }

    #cctvModal .modal-close {
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.10);
      color: #fff;
      font-weight: 900;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }

    #cctvModal .modal-close:hover {
      background: rgba(255, 255, 255, 0.16);
    }

    #cctvModal .modal-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
    }

    #cctvModal img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #cctvModal .modal-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding: 14px 14px;
      pointer-events: none;
      background: linear-gradient(180deg, transparent 65%, rgba(2, 6, 23, .55));
      color: #fff;
      font-size: 14px;
      font-weight: 800;
    }

    #cctvModal .modal-tag {
      background: rgba(53, 183, 255, .22);
      border: 1px solid rgba(255, 255, 255, .3);
      padding: 6px 10px;
      border-radius: 999px;
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <div class="topbar mb-3">
      <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">

        <div class="d-flex align-items-center gap-3">
          <button id="brandReset" class="brand-btn" type="button" title="í´ë¦­í•˜ë©´ ì´ˆê¸°í™”">
            <span class="brand-badge">ğŸª </span>
            <span id="projectName">plunger project</span>
          </button>
          <div class="d-none d-md-block">
            <div class="subtitle">ì„œìš¸ â†” ìˆ˜ì› ì‹¤ì‹œê°„ êµí†µ ë¶„ì„</div>
          </div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2 justify-content-lg-end">
          <div class="segmented" role="group" aria-label="ë°©í–¥ ì„ íƒ">
            <button id="btnUp" class="seg-btn active" type="button">ì„œìš¸ â†’ ìˆ˜ì› (í•˜í–‰)</button>
            <button id="btnDown" class="seg-btn" type="button">ìˆ˜ì› â†’ ì„œìš¸ (ìƒí–‰)</button>
          </div>

          <span id="lastUpdated" class="pill">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</span>

          <button id="btnRefresh" class="btn btn-sky" type="button">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
    </div>

    <div class="row g-3">

      <div class="col-12 col-lg-3">
        <div class="panel h-stretch">
          <div class="panel-header">
            <div>
              <div id="leftLabel" class="panel-sub">ìƒí–‰ ê¸°ì¤€</div>
            </div>
            <span class="pill">LIVE</span>
          </div>

          <div class="video-wrap">
            <div class="frame small-frame cctv" id="cctvLeft1">
              <img id="left1Img" src="" alt="CCTV 1">
              <div class="overlay">
                <span class="tag" id="left1Tag">ì±„ë„ 1</span>
                <span id="left1Time">--:--</span>
              </div>
            </div>
            <div class="frame small-frame cctv" id="cctvLeft2">
              <img id="left2Img" src="" alt="CCTV 2">
              <div class="overlay">
                <span class="tag" id="left2Tag">ì±„ë„ 2</span>
                <span id="left2Time">--:--</span>
              </div>
            </div>
            <div class="frame small-frame cctv" id="cctvLeft3">
              <img id="left3Img" src="" alt="CCTV 3">
              <div class="overlay">
                <span class="tag" id="left3Tag">ì±„ë„ 3</span>
                <span id="left3Time">--:--</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="panel">
          <div class="panel-header">
            <div>
              <p class="panel-title mb-1">ì§€ë„ (ì…ë ¥ê°’/ì„ íƒ êµ¬ê°„)</p>
              <div class="panel-sub">ì‹¤ì‹œê°„ êµí†µ íë¦„ ì‹œê°í™”</div>
            </div>
            <span class="pill" id="routePill">ì„œìš¸ â†’ ìˆ˜ì›</span>
          </div>

          <div class="video-wrap">
            <div class="frame map-frame no-hover">
              <img id="mapImg" src="/front/route_map.png" alt="Map">
            </div>

            <div class="row g-2 mt-1">
              <div class="col-12 col-md-4">
                <label class="form-label small mb-1 text-secondary fw-bold">êµ¬ê°„ ì„ íƒ</label>
                <select id="sourceSelect" class="form-select">
                  <option value="1" selected>ì±„ë„ 1</option>
                  <option value="2">ì±„ë„ 2</option>
                  <option value="3">ì±„ë„ 3</option>
                  <option value="4">ì±„ë„ 4</option>
                  <option value="5">ì±„ë„ 5</option>
                  <option value="6">ì±„ë„ 6</option>
                </select>
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label small mb-1 text-secondary fw-bold">ìƒíƒœ</label>
                <div id="statusPill" class="pill w-100 text-center">-</div>
              </div>

              <div class="col-6 col-md-4">
                <label class="form-label small mb-1 text-secondary fw-bold">ì—…ë°ì´íŠ¸</label>
                <div id="syncPill" class="pill w-100 text-center">ì‹¤ì‹œê°„</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-3">
        <div class="panel h-stretch">
          <div class="panel-header">
            <div>
              <div id="rightLabel" class="panel-sub">ìƒí–‰ ê¸°ì¤€</div>
            </div>
            <span class="pill">LIVE</span>
          </div>

          <div class="video-wrap">
            <div class="frame small-frame cctv" id="cctvRight1">
              <img id="right1Img" src="" alt="CCTV 4">
              <div class="overlay">
                <span class="tag" id="right1Tag">ì±„ë„ 4</span>
                <span id="right1Time">--:--</span>
              </div>
            </div>
            <div class="frame small-frame cctv" id="cctvRight2">
              <img id="right2Img" src="" alt="CCTV 5">
              <div class="overlay">
                <span class="tag" id="right2Tag">ì±„ë„ 5</span>
                <span id="right2Time">--:--</span>
              </div>
            </div>
            <div class="frame small-frame cctv" id="cctvRight3">
              <img id="right3Img" src="" alt="CCTV 6">
              <div class="overlay">
                <span class="tag" id="right3Tag">ì±„ë„ 6</span>
                <span id="right3Time">--:--</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="panel">
          <div class="panel-header">
            <div>
              <p class="panel-title mb-1">í†µê³„ ë¶„ì„ ZONE</p>
              <div class="panel-sub">í˜„ì¬ ì„ íƒëœ ì±„ë„ì˜ ì‹¤ì‹œê°„ AI ë¶„ì„ ë°ì´í„°</div>
            </div>
          </div>

          <div class="analysis-zone">
            <div class="row g-3">
              <div class="col-12 col-md-3">
                <div class="metric">
                  <div class="k">ì ìœ ìœ¨ (Up)</div>
                  <div class="v" id="mCongestionUp">--%</div>
                  <div class="hint" id="statusUp">-</div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="metric">
                  <div class="k">ì ìœ ìœ¨ (Low)</div>
                  <div class="v" id="mCongestionLow">--%</div>
                  <div class="hint" id="statusLow">-</div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="metric">
                  <div class="k">í˜„ì¬ ì°¨ëŸ‰ ìˆ˜</div>
                  <div class="v" id="mVolume">--</div>
                  <div class="hint">íƒì§€ëœ ê°ì²´ ìˆ˜</div>
                </div>
              </div>
              <div class="col-12 col-md-3">
                <div class="metric">
                  <div class="k">ë¶„ì„ ìƒíƒœ</div>
                  <div class="v" id="mEvents">Active</div>
                  <div class="hint">AI ì„œë²„ ì—°ê²°ë¨</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div></div><div id="cctvModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-topbar">
        <span id="modalTitle">í™•ëŒ€ ë³´ê¸°</span>
        <button type="button" class="modal-close" id="modalCloseBtn">ë‹«ê¸° âœ•</button>
      </div>
      <div class="modal-frame">
        <img id="modalImg" src="">
      </div>
    </div>
  </div>

  <script>
    // 1. ì˜ìƒ ìŠ¤íŠ¸ë¦¼ ì—°ê²° (FastAPIì˜ /video_feed ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
    function initCCTV() {
      document.getElementById("left1Img").src = "/video_feed/1";
      document.getElementById("left2Img").src = "/video_feed/2";
      document.getElementById("left3Img").src = "/video_feed/3";
      document.getElementById("right1Img").src = "/video_feed/4";
      document.getElementById("right2Img").src = "/video_feed/5";
      document.getElementById("right3Img").src = "/video_feed/6";
    }

    // 2. ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ (FastAPIì˜ /api/v1/traffic/id ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©)
    async function updateTrafficData() {
      const channelId = document.getElementById("sourceSelect").value;
      try {
        const response = await fetch(`/api/v1/traffic/${channelId}`);
        if (!response.ok) return;
        
        const data = await response.json();
        
        // ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
        if (data.results.up) {
            document.getElementById("mCongestionUp").textContent = data.results.up.occupancy_rate + "%";
            document.getElementById("statusUp").textContent = data.results.up.status;
        }
        if (data.results.low) {
            document.getElementById("mCongestionLow").textContent = data.results.low.occupancy_rate + "%";
            document.getElementById("statusLow").textContent = data.results.low.status;
        }
        document.getElementById("mVolume").textContent = data.vehicle_total_count + "ëŒ€";
        document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString();
        document.getElementById("statusPill").textContent = data.results.up?.status || "ì—°ê²°ë¨";

      } catch (e) {
        console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
      }
    }

    // 3. ëª¨ë‹¬ ê¸°ëŠ¥
    const cctvModal = document.getElementById("cctvModal");
    const modalImg = document.getElementById("modalImg");
    
    document.querySelectorAll(".frame.cctv").forEach((frame, index) => {
      frame.addEventListener("click", () => {
        const channelId = index + 1;
        modalImg.src = `/video_feed/${channelId}`;
        cctvModal.classList.add("open");
      });
    });

    document.getElementById("modalCloseBtn").addEventListener("click", () => {
      cctvModal.classList.remove("open");
      modalImg.src = ""; // ìŠ¤íŠ¸ë¦¼ ì¤‘ë‹¨
    });

    // ì´ˆê¸°í™” ë° ì£¼ê¸°ì  ì‹¤í–‰
    window.onload = () => {
      initCCTV();
      setInterval(updateTrafficData, 1000); // 1ì´ˆë§ˆë‹¤ ë°ì´í„° ê°±ì‹ 
    };
  </script>
</body>
</html>